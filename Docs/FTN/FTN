FTN Mailer Implementation
=========================

Overview
--------
The FTN (FidoNet Technology Network) mailer is a Wimp application that provides
BinkP protocol support for exchanging mail and files with other FTN systems.
It runs as a separate task from the main Converse Server and handles both
inbound and outbound connections.

Features
--------
* BinkP/1.0 protocol implementation
* Multiple simultaneous sessions (up to 4)
* BSO (Binkley-Style Outbound) directory structure
* Automatic inbound mail tossing
* Multiple network addresses (up to 8)
* Multiple uplink definitions
* Scrolling connection log window
* Integration with Converse Server via Wimp messages


Architecture
------------
The FTN mailer consists of several components:

  mailer.c   - Main application, Wimp interface, session management
  binkp.c    - BinkP protocol implementation
  queue.c    - Outbound queue management (BSO structure)
  tosser.c   - Inbound packet processing
  timer.c    - Timer utilities for polling

The mailer communicates with other Converse modules:
* Support Module (0x5AA86) - Reads FTN configuration
* Filer Module (0x5AA40) - Writes to FTN log


BinkP Protocol
--------------
BinkP is a TCP/IP protocol for FTN mail transfer. Default port is 24554.

Frame Structure:
  Bytes 0-1: Length (big-endian), high bit indicates command (1) or data (0)
  Bytes 2+:  Payload (command byte + arguments, or raw file data)

Commands:
  M_NUL (0)  - Information exchange (SYS, ZYZ, LOC, NDL, TIME, VER, etc.)
  M_ADR (1)  - Present FTN addresses
  M_PWD (2)  - Send password (or CRAM-MD5 response)
  M_FILE (3) - File header (name size time offset)
  M_OK (4)   - Password accepted
  M_EOB (5)  - End of batch
  M_GOT (6)  - File received successfully
  M_ERR (7)  - Fatal error, session ends
  M_BSY (8)  - System busy, try later
  M_GET (9)  - Request file (resume support)
  M_SKIP (10)- Skip file


Session Flow
------------
Inbound (answering) session:
  1. Accept TCP connection
  2. Send M_NUL options (OPT, SYS, ZYZ, LOC, NDL, TIME, VER)
  3. Send M_ADR with our addresses
  4. Receive M_NUL options from remote
  5. Receive M_ADR from remote
  6. Receive M_PWD from remote
  7. Validate password, send M_OK or M_ERR
  8. Exchange files (M_FILE, data frames, M_GOT)
  9. Exchange M_EOB when done
  10. Close connection

Outbound (calling) session:
  1. Connect to remote host
  2. Receive M_NUL options
  3. Receive M_ADR from remote
  4. Send M_NUL options
  5. Send M_ADR with our addresses
  6. Send M_PWD
  7. Receive M_OK or M_ERR
  8. Exchange files
  9. Exchange M_EOB
  10. Close connection


BSO Directory Structure
-----------------------
The mailer uses BSO (Binkley-Style Outbound) structure, adapted for RISC OS
(dots removed from filenames):

  <outbound>/              Default zone (zone 2 for FidoNet)
  <outbound>001/           Zone 1 files
  <outbound>003/           Zone 3 files

Within each zone directory, files are named by net/node in hex:

  NNNNNNNNOUT   Normal priority outbound mail packet
  NNNNNNNNHUT   Hold - only send when remote calls
  NNNNNNNNDUT   Direct - send directly, no routing
  NNNNNNNNCUT   Crash - immediate delivery
  NNNNNNNNIUT   Immediate - highest priority
  NNNNNNNNFLO   File attach list (normal)
  NNNNNNNNHLO   File attach list (hold)
  NNNNNNNNCLO   File attach list (crash)

For point addresses:
  NNNNNNNNPNT/            Point directory for net/node
  NNNNNNNNPNT/PPPPPPPP*   Point files (point number in hex)


File Transfer
-------------
File names are converted for RISC OS compatibility:
  - Dots are removed (e.g., "packet.pkt" becomes "packetpkt")
  - Maximum 10 character leafnames
  - Invalid characters are replaced or removed

Incoming files are placed in the temp inbound directory first, then moved
to the main inbound directory on successful completion.


Session State Machine
---------------------
  IDLE        - No active session
  CONNECTING  - TCP connect in progress (outbound)
  WAIT_NUL    - Waiting for M_NUL options
  WAIT_ADR    - Waiting for M_ADR
  WAIT_PWD    - Waiting for M_PWD (inbound)
  WAIT_OK     - Waiting for M_OK (outbound)
  AUTHENTICATED - Password accepted, ready for transfer
  TRANSFER    - Exchanging files
  WAIT_EOB    - Waiting for end of batch
  CLOSING     - Session ending normally
  ERROR       - Session ended due to error


Wimp Integration
----------------
The mailer runs as a Wimp task with:
* Iconbar icon - Click to open connection log, menu for poll/toss/quit
* Connection log window - Scrolling display of session activity
* Status window - Shows current operation during poll/toss

Wimp Messages:
  0x5AA00 (LINE_BROADCAST) - Shutdown request from Server (reason 0)

The mailer quits when it receives the shutdown broadcast from the Server.


CLI Operations (via menu)
-------------------------
Poll    - Scan outbound queue and connect to nodes with waiting mail
Toss    - Process inbound packets and import messages


Statistics Tracked
------------------
* Total sessions (inbound + outbound)
* Files sent/received
* Bytes sent/received
* Session start time


Error Handling
--------------
* Connection timeouts (60 seconds to connect)
* Session timeouts (5 minutes of inactivity)
* Password failures logged and session closed
* File transfer errors reported via M_ERR


Logging
-------
All activity is logged via the Filer module's FTN log:
  <Converse$Dir>.Logs.FTN

Log entries include:
* Session start/end with statistics
* Authentication results
* File transfers
* Errors


Version Information
-------------------
Current Version: 0.01
Task Name: "Converse FTN"
