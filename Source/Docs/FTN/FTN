FTN Mailer Implementation
=========================

Overview
--------
The FTN (FidoNet Technology Network) mailer is a Wimp application that provides
BinkP protocol support for exchanging mail and files with other FTN systems.
It runs as a separate task from the main Converse Server and handles both
inbound and outbound connections.

Features
--------
* BinkP/1.1 protocol implementation
* CRAM-MD5 authentication
* NR mode (Non-Reliable) for streaming transfers
* ND mode (No Dupes) to prevent duplicate file reception
* Session restart (multiple batches per connection)
* M_GET resume support for interrupted transfers
* Encryption (Roger Schlafly algorithm, password-based)
* TRF traffic info exchange
* Multiple simultaneous sessions (up to 4)
* BSO (Binkley-Style Outbound) directory structure
* Automatic inbound mail tossing
* Multiple network addresses (up to 8)
* Multiple uplink definitions with aliases
* Echomail group filtering for selective routing
* Scrolling connection log window
* Integration with Converse Server via Wimp messages


Architecture
------------
The FTN mailer consists of several components:

  mailer.c   - Main application, Wimp interface, session management
  binkp.c    - BinkP protocol implementation
  queue.c    - Outbound queue management (BSO structure)
  tosser.c   - Inbound packet processing, arcmail extraction
  scanner.c  - Outbound message scanning and routing
  packer.c   - Outbound packet creation, arcmail bundling
  tic.c      - TIC file processing for file distribution
  freq.c     - FREQ (File Request) handling
  crypt.c    - Session encryption (Roger Schlafly algorithm)
  unzip.c    - ZIP archive extraction (DEFLATE decompression)
  zip.c      - ZIP archive creation (DEFLATE compression)
  timer.c    - Timer utilities for polling

The mailer communicates with other Converse modules:
* Support Module (0x5AA86) - Reads FTN configuration
* Filer Module (0x5AA40) - Writes to FTN log


BinkP Protocol
--------------
BinkP is a TCP/IP protocol for FTN mail transfer. Default port is 24554.
This implementation supports BinkP/1.1 with extensions.

Frame Structure:
  Bytes 0-1: Length (big-endian), high bit indicates command (1) or data (0)
  Bytes 2+:  Payload (command byte + arguments, or raw file data)

Commands:
  M_NUL (0)  - Information exchange (SYS, ZYZ, LOC, NDL, TIME, VER, TRF, etc.)
  M_ADR (1)  - Present FTN addresses
  M_PWD (2)  - Send password (or CRAM-MD5 response)
  M_FILE (3) - File header (name size time offset)
  M_OK (4)   - Password accepted
  M_EOB (5)  - End of batch
  M_GOT (6)  - File received successfully
  M_ERR (7)  - Fatal error, session ends
  M_BSY (8)  - System busy, try later
  M_GET (9)  - Request file at offset (resume support)
  M_SKIP (10)- Skip file (receiver can abort reception)

Session Options (sent in M_NUL OPT):
  NR     - Non-Reliable mode (streaming without per-block ACKs)
  ND     - No Dupes mode (track received files to prevent duplicates)
  NDA    - Asymmetric ND (only one side needs ND support)
  CRYPT  - Encryption supported (enabled after M_OK exchange)
  GZ     - GZip compression supported (stub - not yet implemented)
  BZ2    - BZip2 compression supported (stub - not yet implemented)
  EXTCMD - Extended command parameters supported

M_NUL Keywords:
  SYS    - System name
  ZYZ    - Sysop name
  LOC    - Location
  NDL    - Node flags
  TIME   - Local time
  VER    - Software version (name/version binkp/1.1)
  TRF    - Traffic info (pending mail bytes, pending file bytes)
  OPT    - Session options (NR ND NDA CRYPT GZ BZ2 EXTCMD)


Session Flow
------------
Inbound (answering) session:
  1. Accept TCP connection
  2. Send M_NUL options (OPT, SYS, ZYZ, LOC, NDL, TIME, VER)
  3. Send M_ADR with our addresses
  4. Receive M_NUL options from remote
  5. Receive M_ADR from remote
  6. Receive M_PWD from remote
  7. Validate password, send M_OK or M_ERR
  8. Exchange files (M_FILE, data frames, M_GOT)
  9. Exchange M_EOB when done
  10. Close connection

Outbound (calling) session:
  1. Connect to remote host
  2. Receive M_NUL options
  3. Receive M_ADR from remote
  4. Send M_NUL options
  5. Send M_ADR with our addresses
  6. Send M_PWD
  7. Receive M_OK or M_ERR
  8. Exchange files
  9. Exchange M_EOB
  10. Close connection (or restart for another batch)


BinkP 1.1 Extensions
--------------------

NR Mode (Non-Reliable):
  In NR mode, the sender streams file data without waiting for M_GOT after
  each file. Files are sent with offset -1 in M_FILE to indicate NR mode.
  The receiver tracks received files and sends M_GOT after each completes.
  This improves throughput over high-latency links.

ND Mode (No Dupes):
  ND mode prevents duplicate file reception across session restarts.
  Each side tracks which files have been received during the connection.
  If the same filename is offered again (e.g., after session restart),
  M_GOT is sent immediately without re-receiving the file.

Session Restart:
  After both sides exchange M_EOB, the session can restart for another
  batch instead of disconnecting. This allows:
  - Receiving files that arrived during the session
  - Sending files queued during the session
  - Multiple rounds of transfer on a single TCP connection
  The batch number is incremented each restart.

M_GET Resume:
  When a file transfer is interrupted, the receiver can send M_GET with
  the offset where transfer should resume. The sender seeks to that
  position and continues sending from there. This avoids retransmitting
  already-received data.

M_SKIP During Receive:
  The receiver can abort reception of a file in progress by sending
  M_SKIP. This is useful if disk space runs low or if the file is
  determined to be unwanted mid-transfer.

Encryption:
  Session encryption uses Roger Schlafly's algorithm with CRC32-based
  key derivation. Both sides must have the same password configured.
  Encryption is negotiated via the CRYPT option and activated after
  successful M_OK exchange. All subsequent frames are encrypted.

TRF Info:
  Traffic information is exchanged during handshake via M_NUL TRF.
  Format: "TRF <mail_bytes> <file_bytes>"
  This allows each side to know how much data the other has pending,
  useful for estimating transfer time.

Buggy NR Workaround:
  Some older BinkP implementations have buggy NR mode. The mailer
  detects these based on version strings and falls back to reliable
  mode when necessary.


BSO Directory Structure
-----------------------
The mailer uses BSO (Binkley-Style Outbound) structure, adapted for RISC OS
(dots removed from filenames):

  <outbound>/              Default zone (zone 2 for FidoNet)
  <outbound>001/           Zone 1 files
  <outbound>003/           Zone 3 files

Within each zone directory, files are named by net/node in hex:

  NNNNNNNNOUT   Normal priority outbound mail packet
  NNNNNNNNHUT   Hold - only send when remote calls
  NNNNNNNNDUT   Direct - send directly, no routing
  NNNNNNNNCUT   Crash - immediate delivery
  NNNNNNNNIUT   Immediate - highest priority
  NNNNNNNNFLO   File attach list (normal)
  NNNNNNNNHLO   File attach list (hold)
  NNNNNNNNCLO   File attach list (crash)

For point addresses:
  NNNNNNNNPNT/            Point directory for net/node
  NNNNNNNNPNT/PPPPPPPP*   Point files (point number in hex)


File Transfer
-------------
File names are converted for RISC OS compatibility:
  - Dots are removed (e.g., "packet.pkt" becomes "packetpkt")
  - Maximum 10 character leafnames
  - Invalid characters are replaced or removed

Incoming files are placed in the temp inbound directory first, then moved
to the main inbound directory on successful completion.


Session State Machine
---------------------
  IDLE          - No active session
  CONNECTING    - TCP connect in progress (outbound)
  WAIT_NUL      - Waiting for M_NUL options
  WAIT_ADR      - Waiting for M_ADR
  WAIT_PWD      - Waiting for M_PWD (inbound)
  WAIT_OK       - Waiting for M_OK (outbound)
  AUTHENTICATED - Password accepted, encryption activated if negotiated
  TRANSFER      - Exchanging files
  WAIT_EOB      - Waiting for end of batch
  CLOSING       - Session ending normally
  ERROR         - Session ended due to error

Session flags track additional state:
  nr_mode       - NR mode negotiated (bitmask: 1=we want, 2=they want)
  nd_mode       - ND mode negotiated (bitmask: 1=we want, 2=they want)
  crypt_flag    - Encryption state (1=we want, 2=they want, 4=active)
  batch_number  - Current batch number (increments on session restart)
  local_eob     - We have sent M_EOB
  remote_eob    - Remote has sent M_EOB


Wimp Integration
----------------
The mailer runs as a Wimp task with:
* Iconbar icon - Click to open connection log, menu for poll/toss/quit
* Connection log window - Scrolling display of session activity
* Status window - Shows current operation during poll/toss

Wimp Messages:
  0x5AA00 (LINE_BROADCAST) - Shutdown request from Server (reason 0)

The mailer quits when it receives the shutdown broadcast from the Server.


CLI Operations (via menu)
-------------------------
Poll    - Scan outbound queue and connect to nodes with waiting mail
Toss    - Process inbound packets and import messages


Statistics Tracked
------------------
* Total sessions (inbound + outbound)
* Files sent/received
* Bytes sent/received
* Session start time


Error Handling
--------------
* Connection timeouts (60 seconds to connect)
* Session timeouts (5 minutes of inactivity)
* Password failures logged and session closed
* File transfer errors reported via M_ERR


Logging
-------
All activity is logged via the Filer module's FTN log:
  <Converse$Dir>.Logs.FTN

Log entries include:
* Session start/end with statistics
* Authentication results
* File transfers
* Encryption status
* NR/ND mode negotiation
* Errors


Encryption Implementation
-------------------------
The mailer uses Roger Schlafly's encryption algorithm, compatible with
BinkD and other FTN mailers. Key features:

Algorithm:
  - Uses a CRC32 lookup table for key derivation
  - Maintains three 32-bit keys that evolve with each byte
  - Symmetric encryption (same algorithm for encrypt/decrypt)

Key Initialization:
  - Keys are derived from the session password
  - Each character of the password updates all three keys
  - Initial key values: 0x12345678, 0x23456789, 0x34567890

Operation:
  - For each byte, a keystream byte is derived from the keys
  - The byte is XORed with the keystream
  - The original (plaintext for encrypt, ciphertext for decrypt)
    byte is used to update the keys for the next byte

Activation:
  - Both sides must advertise CRYPT in their OPT
  - Encryption activates immediately after M_OK exchange
  - All subsequent frames are encrypted
  - Separate key states are maintained for TX and RX


Compression (Stub)
------------------
Stream compression support (GZ/BZ2) is stubbed out pending availability of
zlib/bzip2 libraries for RISC OS. The framework is in place:
  - GZ (type 1) - GZip/deflate stream compression
  - BZ2 (type 2) - BZip2 stream compression

When stream compression is negotiated, the compress.c stubs log a message
indicating compression is not available and pass data through unchanged.

Note: Arcmail (ZIP file) compression IS fully supported - see below.


Arcmail Support
---------------
The mailer includes native ZIP file support for handling arcmail bundles.
Arcmail is the traditional FTN method of bundling multiple packets into
a single compressed file for more efficient transfer.

Inbound Arcmail (Extraction):
  The tosser automatically detects and extracts arcmail bundles when
  scanning the inbound directory. Supported file extensions:
  
  - .mo0 through .mo9  (Monday)
  - .tu0 through .tu9  (Tuesday)
  - .we0 through .we9  (Wednesday)
  - .th0 through .th9  (Thursday)
  - .fr0 through .fr9  (Friday)
  - .sa0 through .sa9  (Saturday)
  - .su0 through .su9  (Sunday)
  - .zip              (Generic ZIP files)

  Processing flow:
  1. Tosser scans zone inbound directory
  2. Arcmail files are detected by extension
  3. ZIP archive is opened and scanned for .pkt files
  4. Each .pkt file is extracted to a temp directory
  5. Extracted packets are processed normally
  6. Original arcmail is moved to Processed/ directory

Outbound Arcmail (Creation):
  The packer can compress outbound packets into arcmail bundles using
  the following functions:

  packer_create_arcmail(packet_path, dest_addr)
    - Compresses a single packet into an arcmail bundle
    - Original packet is deleted after successful compression
    - Archive named with timestamp and day-of-week extension

  packer_create_arcmail_multi(packet_paths, count, dest_addr)
    - Bundles multiple packets into a single archive
    - All original packets are deleted after compression
    - More efficient for multiple packets to same destination

Compression Method:
  - Uses DEFLATE algorithm (RFC 1951)
  - LZ77 with hash chain for pattern matching
  - Fixed Huffman codes for good compression/speed balance
  - Typical compression ratio: 50-70% for FTN packets
  - Compatible with all standard ZIP tools

Technical Details:
  - unzip.c: Full DEFLATE decompressor implementation
  - zip.c: DEFLATE compressor with LZ77 matching
  - Store method (uncompressed) also supported
  - CRC-32 verification on extraction
  - No external library dependencies


File Requests (FREQ)
--------------------
The mailer supports FTN file requests in both directions.

Requesting Files (Outbound FREQ):
  Use the FREQ window (Commands menu) to request files from remote nodes.
  This creates a .REQ file in the BSO outbound directory. When connecting
  to that node, the mailer reads the .REQ file and sends M_GET commands
  with size=0, time=0 (the FREQ convention) for each filename.

  REQ file format: One entry per line
    filename              Request without password
    filename !password    Request with password protection

  The FREQ window provides fields for filename, target address, and an
  optional password. If a password is specified, it's included in the
  M_GET command sent to the remote system.

Responding to Requests (Inbound FREQ):
  When a remote node sends M_GET with size=0 and time=0, it's a file request.
  The mailer searches the configured freqpath directory for matching files.
  
  - If found, the file is queued for immediate send (M_FILE response)
  - If not found, M_SKIP is sent to indicate unavailability
  - Wildcard patterns (* and ?) are supported in the requested filename

Configuration:
  freqpath    <Converse$Dir>.FTN.Freq
  freqexec    (not yet implemented - for external FREQ processor)

If freqpath is not configured, all FREQ requests are denied.


Version Information
-------------------
Current Version: 0.02
Task Name: "Mailer"
Protocol: BinkP/1.1

Compatibility:
  - BinkD (tested)
  - Other BinkP/1.1 compliant mailers
  - Falls back gracefully with BinkP/1.0 systems
