/*
 * Telnet BBS Door Server
 * Copyright (c) Andrew Timmins, 2023. All rights reserved.
 *
*/

#ifndef MAIN_H
#define MAIN_H

    #include <time.h>

    /* Socket includes for struct sockaddr_in, fd_set etc */
    #include "sys/types.h"
    #include "sys/socket.h"
    #include "sys/time.h"
    #include "netinet/in.h"

    /* Desk Includes */
    #include "C:Desk.Core.h"
    #include "C:Desk.Menu.h"
    #include "C:Desk.Dialog.h"
    #include "C:Desk.Dialog2.h"

    /* Defines */
    #define iconbar_menu_proginfo    0
    #define iconbar_menu_systeminfo  1
    #define iconbar_menu_usereditor  2
    #define iconbar_menu_uploadfile  3
    #define iconbar_menu_quit        4

    #define Telnet_EOF               236
    #define Telnet_SUSP              237
    #define Telnet_ABORT             238
    #define Telnet_EOR               239
    #define Telnet_SE                240
    #define Telnet_NOP               241
    #define Telnet_DM                242
    #define Telnet_BRK               243
    #define Telnet_IP                244
    #define Telnet_AO                245
    #define Telnet_AYT               246
    #define Telnet_EC                247
    #define Telnet_EL                248
    #define Telnet_GA                249
    #define Telnet_SB                250
    #define Telnet_WILL              251
    #define Telnet_WONT              252
    #define Telnet_DO                253
    #define Telnet_DONT              254
    #define Telnet_IAC               255

    #define Option_BINARY            0
    #define Option_ECHO              1
    #define Option_SUPRESS           3
    #define Option_STATUS            5
    #define Option_TIMING            6
    #define Option_TERMTYPE          24
    #define Option_WINDOWSIZE        31
    #define Option_TERMSPEED         32
    #define Option_LFLOW             33
    #define Option_LINEMODE          34
    #define Option_ENVIRON           36

    #define Resolver_GetHost         0x66001

    #define MAX_LINES                32

    /* Line connection types */
    typedef enum
    {
        LINE_TYPE_TELNET = 0,   /* TCP/IP telnet connections (default) */
        LINE_TYPE_SERIAL = 1,   /* Serial/modem via BlockDriver */
        LINE_TYPE_LOCAL  = 2    /* Local desktop login only */
    } line_type_t;

    /* Variables */
    struct wimp_components
    {
        Desk_bool quit;
        Desk_icon_handle iconbar_icon_handle;
        Desk_menu_ptr iconbar_menu_handle;
    };

    typedef struct
    {
        char name[256];
        char sysop[256];
        char contact[256];
        char hostname[256];
        int port;
        int timeout;
        char botstopper[4];
        char needlogin[4];
        char closed[4];
        char pager[4];
        char ftnmail[4];
        char webserver[4];
        char anykey[256];
        char more[256];
        char chatstart[256];
        char chatend[256];
        char prelogon[256];
        char postlogon[256];
        char logoff[256];
        char welcome[256];
        char newuser[256];
        char timeup[256];
        char lockedout[256];
        char closedsys[256];
        char aftermail[256];
        char protocol[256];
    } system_components;

    /* Icon text buffers for dynamic line icons */
    typedef struct
    {
        char *line_text;
        char *type_text;
        char *user_text;
        char *activity_text;
        char *hostname_text;
        char *timer_text;
        char *action_text;
        char *view_text;
        char *logon_text;
    } line_icon_buffers;

    typedef struct
    {
        char line[4];
        char enabled[4];
        char botstopper[128];
        char hello[256];

        /* Line type */
        line_type_t type;

        /* Telnet-specific */
        int socket;
        struct sockaddr_in remote_addr;

        /* Serial-specific (BlockDriver) */
        int (*driver)(int, ...);        /* BlockDriver function pointer */
        int port_number;                /* Port number (0-based) */
        int baud_rate;                  /* Baud rate (e.g., 115200) */
        int word_format;                /* Data/parity/stop encoded */
        int flow_control;               /* Flow control mode */
        int rings;                      /* Rings to wait before answer */
        int carrier_detect;             /* Current DCD state */
        char init[64];                  /* Modem init string */
        char ring[32];                  /* Ring indicator */
        char answer[32];                /* Answer command */
        char driver_name[32];           /* BlockDriver name */

        /* Common */
        int connectedtime;
        clock_t last_activity;
        long timer;
        int resolved;
        char remote[128];
        line_icon_buffers icons;

        /* Pending write buffer for partial socket writes */
        char pending_buffer[1536];
        int pending_offset;
        int pending_length;
    } line_components;

    /* Extern declarations - definitions in main.c */
    extern Desk_dialog2_block *proginfo_window;
    extern Desk_dialog2_block *systeminfo_window;
    extern Desk_window_handle main_window;
    extern Desk_window_handle waiting_window;
    
    extern char app_version[];
    extern char app_compiled[];
    extern char small_app_compiled[];

    extern char waiting_user[];
    extern char user_activity[];

    extern char error_bind[];
    extern char error_listen[];
    extern char error_busy[];
    
    extern char error_cantfindsystemconfig[];
    extern char error_cantfindlineconfig[];
    extern char error_toomanylines[];
    extern char error_nolinesdefined[];

    extern system_components system_configuration[];

    extern line_components line_configuration[];
    extern int line_configurations;
    extern int line_task_handles[];

    extern int listening_socket;
    extern int active_sockets;
    extern fd_set is_socket_ready;
    extern struct timeval socket_timeout;
    extern char socket_buffer[];

    /* Status window state */
    extern int connections_enabled;
    extern int chat_pager_enabled;
    extern time_t server_start_time;
    extern long status_update_timer;
    extern char error_connections_disabled[];

    /* Main window icon column indices */
    #define MAIN_WINDOW_COLUMN_LINE      0
    #define MAIN_WINDOW_COLUMN_USER      1
    #define MAIN_WINDOW_COLUMN_ACTIVITY  2
    #define MAIN_WINDOW_COLUMN_HOSTNAME  3
    #define MAIN_WINDOW_COLUMN_TIMER     4
    #define MAIN_WINDOW_COLUMN_ACTION    5
    #define MAIN_WINDOW_COLUMN_VIEW      6
    #define MAIN_WINDOW_COLUMN_LOGON     7

    /* Icon helper function */
    int main_window_icon_index(int line, int column);

#endif
