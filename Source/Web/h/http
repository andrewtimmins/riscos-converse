/* ******************************************************************************************************************************************************** */
/* Web Server - HTTP Header                                                                                                                                 */
/* ******************************************************************************************************************************************************** */

#ifndef HTTP_H
#define HTTP_H

#include <stddef.h>

/* HTTP Status Codes */
#define HTTP_STATUS_OK              200
#define HTTP_STATUS_BAD_REQUEST     400
#define HTTP_STATUS_FORBIDDEN       403
#define HTTP_STATUS_NOT_FOUND       404
#define HTTP_STATUS_SERVER_ERROR    500

/* Maximum sizes */
#define HTTP_MAX_METHOD     8
#define HTTP_MAX_PATH       256
#define HTTP_MAX_VERSION    16
#define HTTP_MAX_HEADER     4096

/* HTTP Request structure */
typedef struct
{
    char method[HTTP_MAX_METHOD];       /* GET, HEAD */
    char path[HTTP_MAX_PATH];           /* /path/to/file */
    char version[HTTP_MAX_VERSION];     /* HTTP/1.0 or HTTP/1.1 */
    int complete;                       /* 1 if full request received */
} HTTP_REQUEST;

/* Parse HTTP request from buffer
 * Returns 1 if complete request parsed, 0 if incomplete, -1 on error
 */
int http_parse_request(const char *buffer, int len, HTTP_REQUEST *req);

/* Get MIME type for a filename based on RISC OS filetype or extension
 * Returns pointer to static string
 */
const char *http_get_mime_type(const char *filename, int filetype);

/* Get status text for HTTP status code */
const char *http_status_text(int status);

/* Send HTTP response headers
 * Returns bytes written or -1 on error
 */
int http_send_headers(int socket, int status, const char *content_type, long content_length);

/* Send HTTP error response (headers + body)
 * Returns bytes written or -1 on error
 */
int http_send_error(int socket, int status, const char *message);

/* Send file content to socket
 * Returns bytes written or -1 on error
 */
int http_send_file(int socket, const char *filepath);

/* Send data buffer to socket
 * Returns bytes written or -1 on error
 */
int http_send_data(int socket, const char *data, long length);

/* Validate and sanitize request path
 * Returns 1 if path is safe, 0 if potentially dangerous
 */
int http_validate_path(const char *path);

/* Build filesystem path from request path
 * docroot: base directory (e.g., "<Converse$Dir>.Web")
 * request_path: URL path (e.g., "/files/test")
 * out: output buffer for RISC OS path
 * out_size: size of output buffer
 * Returns 1 on success, 0 on error
 */
int http_build_filepath(const char *docroot, const char *request_path,
                        char *out, size_t out_size);

#endif /* HTTP_H */
