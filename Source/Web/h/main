/* ******************************************************************************************************************************************************** */
/* Web Server - Main Header                                                                                                                                 */
/* ******************************************************************************************************************************************************** */

#ifndef MAIN_H
#define MAIN_H

#include <time.h>
#include "C:Desk.Wimp.h"

/* Configuration */
#define WEB_DEFAULT_PORT        80
#define WEB_MAX_CLIENTS         8       /* Reduced for memory */
#define WEB_SMALL_BUFFER_SIZE   4096    /* Small buffer for headers/small requests */
#define WEB_MAX_UPLOAD_SIZE     (2 * 1024 * 1024)  /* Max 2MB upload */
#define WEB_CLIENT_TIMEOUT      60      /* seconds */
#define WEB_DOCROOT             "<Converse$Dir>.Web"
#define WEB_INDEX_FILE          "index"

/* Client states */
#define CLIENT_STATE_FREE       0
#define CLIENT_STATE_CONNECTED  1
#define CLIENT_STATE_RECEIVING  2
#define CLIENT_STATE_SENDING    3

/* Client slot structure */
typedef struct
{
    int socket;                             /* Client socket fd, 0 = free slot */
    int state;                              /* CLIENT_STATE_* */
    clock_t connected;                      /* Connection time for timeout */
    char *recv_buffer;                      /* Dynamically allocated buffer */
    int recv_buffer_size;                   /* Current buffer size */
    int recv_len;                           /* Bytes received so far */
    long content_length;                    /* Expected Content-Length for POST */
    char remote_addr[32];                   /* Client IP address */
} CLIENT_SLOT;

/* Wimp state structure */
typedef struct
{
    Desk_bool quit;
    Desk_icon_handle iconbar_icon;
    Desk_menu_ptr iconbar_menu;
} WIMP_STATE;

/* Global state */
extern WIMP_STATE wimp;
extern CLIENT_SLOT clients[WEB_MAX_CLIENTS];
extern int listen_socket;
extern int listen_port;
extern int active_clients;

/* Networking functions */
void create_listener(int port);
void destroy_listener(void);
void check_listener(void);
void poll_clients(void);
void close_client(int slot);

/* Request handling */
void handle_client_request(int slot);

#endif /* MAIN_H */
