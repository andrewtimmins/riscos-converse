/* ******************************************************************************************************************************************************** */
/* LineTask File Transfer Module                                                                                                                              */
/*                                                                                                                                                            */
/* Dispatcher and common utilities for file transfer protocols (XMODEM, YMODEM, ZMODEM).                                                                      */
/* Protocol-specific code lives in separate files (xmodem.c, ymodem.c, zmodem.c).                                                                             */
/* ******************************************************************************************************************************************************** */

#ifndef LINETASK_TRANSFER_H
#define LINETASK_TRANSFER_H

#include <stdint.h>
#include <time.h>

/* ******************************************************************************************************************************************************** */
/* Transfer Protocol Types                                                                                                                                    */
/* ******************************************************************************************************************************************************** */

typedef enum
{
    TRANSFER_PROTO_XMODEM = 0,      /* Basic XMODEM with checksum */
    TRANSFER_PROTO_XMODEM_CRC,      /* XMODEM with CRC-16 */
    TRANSFER_PROTO_XMODEM_1K,       /* XMODEM with 1K blocks and CRC-16 */
    TRANSFER_PROTO_YMODEM,          /* YMODEM with batch support */
    TRANSFER_PROTO_YMODEM_G,        /* YMODEM-G streaming (no ACKs) */
    TRANSFER_PROTO_ZMODEM,          /* ZMODEM full implementation */
    TRANSFER_PROTO_COUNT            /* Number of protocols */
} transfer_protocol;

/* ******************************************************************************************************************************************************** */
/* Transfer Direction                                                                                                                                         */
/* ******************************************************************************************************************************************************** */

typedef enum
{
    TRANSFER_DIR_SEND,              /* Sending file to remote (download from BBS perspective) */
    TRANSFER_DIR_RECEIVE            /* Receiving file from remote (upload from BBS perspective) */
} transfer_direction;

/* ******************************************************************************************************************************************************** */
/* Transfer State (high-level)                                                                                                                                */
/* ******************************************************************************************************************************************************** */

typedef enum
{
    XFER_IDLE,                      /* No transfer active */
    XFER_ACTIVE,                    /* Transfer in progress */
    XFER_COMPLETE,                  /* Transfer completed successfully */
    XFER_ERROR                      /* Unrecoverable error occurred */
} transfer_state;

/* ******************************************************************************************************************************************************** */
/* Transfer Result Codes                                                                                                                                      */
/* ******************************************************************************************************************************************************** */

typedef enum
{
    XFER_RESULT_OK,                 /* Transfer completed successfully */
    XFER_RESULT_CANCELLED,          /* User/sysop cancelled */
    XFER_RESULT_TIMEOUT,            /* Timed out waiting for response */
    XFER_RESULT_TOO_MANY_ERRORS,    /* Too many retries */
    XFER_RESULT_REMOTE_CANCEL,      /* Remote sent CAN */
    XFER_RESULT_FILE_ERROR,         /* File read/write error */
    XFER_RESULT_PROTOCOL_ERROR,     /* Protocol violation */
    XFER_RESULT_OUT_OF_SYNC,        /* Block sequence error */
    XFER_RESULT_SKIP                /* File skipped (YMODEM/ZMODEM) */
} transfer_result;

/* ******************************************************************************************************************************************************** */
/* Constants                                                                                                                                                  */
/* ******************************************************************************************************************************************************** */

#define TRANSFER_MAX_FILENAME       64
#define TRANSFER_MAX_DESCRIPTION    256
#define TRANSFER_MAX_PATH           256
#define TRANSFER_MAX_ERROR          64

#define TRANSFER_BLOCK_SIZE_128     128
#define TRANSFER_BLOCK_SIZE_1K      1024

/* Timeout values in centiseconds (1cs = 10ms) */
#define TRANSFER_TIMEOUT_START      6000    /* 60 seconds to start transfer */
#define TRANSFER_TIMEOUT_BLOCK      1000    /* 10 seconds per block */
#define TRANSFER_TIMEOUT_ACK        300     /* 3 seconds for ACK */

#define TRANSFER_MAX_ERRORS         10      /* Max consecutive errors before abort */
#define TRANSFER_MAX_START_RETRIES  6       /* Max retries waiting for receiver */

/* ******************************************************************************************************************************************************** */
/* Transfer Session Structure                                                                                                                                 */
/* ******************************************************************************************************************************************************** */

typedef struct
{
    /* Session identification */
    int line;                               /* Pipe line number */
    int active;                             /* Transfer is active */
    transfer_protocol protocol;             /* Which protocol */
    transfer_direction direction;           /* Send or receive */
    
    /* High-level state */
    transfer_state state;                   /* IDLE, ACTIVE, COMPLETE, ERROR */
    transfer_result result;                 /* Result code when complete */
    char error_msg[TRANSFER_MAX_ERROR];     /* Human-readable error description */
    
    /* File info - for SEND (download to user) */
    int filebase_id;                        /* Source filebase ID */
    int file_id;                            /* Source file ID */
    
    /* File info - for RECEIVE (upload from user) */
    char filename[TRANSFER_MAX_FILENAME];           /* Filename (user or protocol provided) */
    char description[TRANSFER_MAX_DESCRIPTION];     /* User-provided description */
    char temp_path[TRANSFER_MAX_PATH];              /* Temp file path during receive */
    int filename_from_protocol;                     /* 1 if YMODEM/ZMODEM provided filename */
    
    /* Progress tracking */
    long file_size;                         /* Total size (known for send, may be 0 for receive) */
    long file_offset;                       /* Current read/write position */
    long bytes_transferred;                 /* Total bytes successfully transferred */
    
    /* Timing */
    uint32_t timeout_target;                /* Centisecond timeout target */
    uint32_t start_time;                    /* Transfer start time */
    
    /* Control */
    int cancel_requested;                   /* Cancel signal from host */
    
    /* File handle for receive */
    void *file_handle;                      /* FILE* for temp file during receive */
    
    /* Protocol-specific state (allocated by protocol init) */
    void *protocol_state;
    
} transfer_session;

/* ******************************************************************************************************************************************************** */
/* Public API - Session Management                                                                                                                            */
/* ******************************************************************************************************************************************************** */

/*
 * Initialise the transfer module.
 * Call once at LineTask startup.
 */
void transfer_init(void);

/*
 * Start sending a file from filebase (BBS download to user).
 *
 * session:     Pointer to session structure (caller allocates)
 * line:        Pipe line number
 * protocol:    Transfer protocol to use
 * filebase_id: Filebase containing the file
 * file_id:     File ID within the filebase
 *
 * Returns: 0 on success, -1 on error (check session->error_msg)
 */
int transfer_start_send(transfer_session *session, int line,
                        transfer_protocol protocol, int filebase_id, int file_id);

/*
 * Start receiving a file (BBS upload from user).
 *
 * session:     Pointer to session structure (caller allocates)
 * line:        Pipe line number
 * protocol:    Transfer protocol to use
 * filename:    Filename for XMODEM (required), or hint for YMODEM/ZMODEM (can be empty)
 * description: User-provided file description
 *
 * Returns: 0 on success, -1 on error (check session->error_msg)
 */
int transfer_start_receive(transfer_session *session, int line,
                           transfer_protocol protocol,
                           const char *filename, const char *description);

/*
 * Poll the transfer state machine.
 * Call this from the null event handler while a transfer is active.
 *
 * Returns: 1 if transfer still active, 0 if complete/error
 */
int transfer_poll(transfer_session *session);

/*
 * Request cancellation of the transfer.
 * The transfer will abort gracefully (sending CAN sequence).
 */
void transfer_cancel(transfer_session *session);

/*
 * Clean up after transfer completes.
 * Frees protocol state and closes any open files.
 */
void transfer_cleanup(transfer_session *session);

/* ******************************************************************************************************************************************************** */
/* Public API - Status Queries                                                                                                                                */
/* ******************************************************************************************************************************************************** */

/*
 * Check if a transfer is currently active.
 */
int transfer_is_active(transfer_session *session);

/*
 * Get transfer progress as percentage (0-100).
 * Returns -1 if unknown (e.g., receiving with unknown file size).
 */
int transfer_get_progress(transfer_session *session);

/*
 * Get human-readable status string.
 */
void transfer_get_status(transfer_session *session, char *buffer, int buffer_size);

/*
 * Get the final filename (useful for YMODEM/ZMODEM where protocol provides name).
 */
const char *transfer_get_filename(transfer_session *session);

/*
 * Get the temp file path (for received files).
 */
const char *transfer_get_temp_path(transfer_session *session);

/* ******************************************************************************************************************************************************** */
/* Utility Functions - For use by protocol implementations                                                                                                    */
/* ******************************************************************************************************************************************************** */

/*
 * Get current time in centiseconds (OS_ReadMonotonicTime).
 */
uint32_t transfer_get_time(void);

/*
 * Set timeout relative to current time.
 */
void transfer_set_timeout(transfer_session *session, int centiseconds);

/*
 * Check if timeout has expired.
 */
int transfer_timeout_expired(transfer_session *session);

/* ******************************************************************************************************************************************************** */
/* File I/O Functions - For use by protocol implementations                                                                                                   */
/* ******************************************************************************************************************************************************** */

/*
 * Read a block of data from the source file (for sending).
 * Uses Filer SWIs to read from filebase.
 *
 * Returns: Number of bytes read, 0 on EOF, -1 on error
 */
int transfer_read_file_block(transfer_session *session, uint8_t *buffer,
                             long offset, int length);

/*
 * Write a block of data to the temp file (for receiving).
 *
 * Returns: Number of bytes written, -1 on error
 */
int transfer_write_file_block(transfer_session *session, const uint8_t *data, int length);

/*
 * Get the total file size (for sending).
 */
long transfer_get_file_size(transfer_session *session);

#endif /* LINETASK_TRANSFER_H */
