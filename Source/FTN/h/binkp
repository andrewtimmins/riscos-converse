/* ******************************************************************************************************************************************************** */
/* FTN Mailer - BinkP Protocol Header                                                                                                                       */
/* ******************************************************************************************************************************************************** */

#ifndef BINKP_H
#define BINKP_H

#include "mailer.h"

/* ******************************************************************************************************************************************************** */
/* BinkP Protocol Constants                                                                                                                                 */
/* ******************************************************************************************************************************************************** */

/* BinkP version we support */
#define BINKP_VERSION               "1.1"

/* Frame type bit - high bit indicates command frame */
#define BINKP_FLAG_COMMAND          0x8000
#define BINKP_MAX_FRAME             32767

/* ******************************************************************************************************************************************************** */
/* BinkP Command Types                                                                                                                                      */
/* ******************************************************************************************************************************************************** */

typedef enum
{
    BINKP_M_NUL  = 0,   /* Site information / keepalive */
    BINKP_M_ADR  = 1,   /* List of addresses */
    BINKP_M_PWD  = 2,   /* Session password */
    BINKP_M_FILE = 3,   /* File information: name size time offset */
    BINKP_M_OK   = 4,   /* Password accepted (strval may be "secure" or "non-secure") */
    BINKP_M_EOB  = 5,   /* End of batch */
    BINKP_M_GOT  = 6,   /* File received: name size time */
    BINKP_M_ERR  = 7,   /* Fatal error, terminate session */
    BINKP_M_BSY  = 8,   /* Busy, try later */
    BINKP_M_GET  = 9,   /* Get file from offset: name size time offset */
    BINKP_M_SKIP = 10   /* Skip file: name size time */
} BINKP_COMMAND;

/* ******************************************************************************************************************************************************** */
/* BinkP Options (sent in M_NUL)                                                                                                                            */
/* ******************************************************************************************************************************************************** */

#define BINKP_OPT_CRAM_MD5          "CRAM-MD5"
#define BINKP_OPT_NR                "NR"        /* Non-reliable mode */
#define BINKP_OPT_ND                "ND"        /* No dupes mode */
#define BINKP_OPT_NDA               "NDA"       /* No dupes asymmetric */
#define BINKP_OPT_MB                "MB"        /* Multiple batch */
#define BINKP_OPT_EXTCMD            "EXTCMD"    /* Extended commands */
#define BINKP_OPT_GZ                "GZ"        /* GZip compression */
#define BINKP_OPT_BZ2               "BZ2"       /* BZip2 compression */
#define BINKP_OPT_CRYPT             "CRYPT"     /* Encryption */

/* NR/ND mode flags (bitfield) */
#define BINKP_WE_NR                 0x01        /* We requested NR mode */
#define BINKP_THEY_NR               0x02        /* They requested NR mode */
#define BINKP_WE_ND                 0x01        /* We requested ND mode */
#define BINKP_THEY_ND               0x02        /* They requested ND mode */

/* Compression type */
#define BINKP_COMPRESS_NONE         0
#define BINKP_COMPRESS_GZ           1           /* GZip/deflate */
#define BINKP_COMPRESS_BZ2          2           /* BZip2 */

/* Encryption flags */
#define BINKP_CRYPT_NONE            0
#define BINKP_CRYPT_WE_WANT         0x01        /* We want encryption */
#define BINKP_CRYPT_THEY_WANT       0x02        /* They want encryption */
#define BINKP_CRYPT_ACTIVE          0x04        /* Encryption is active */

/* Shorthand aliases for crypt flags */
#define BINKP_CRYPT_WE              BINKP_CRYPT_WE_WANT
#define BINKP_CRYPT_THEY            BINKP_CRYPT_THEY_WANT

/* ******************************************************************************************************************************************************** */
/* BinkP Frame Structure                                                                                                                                    */
/* ******************************************************************************************************************************************************** */

typedef struct
{
    int is_command;         /* 1 if command frame, 0 if data frame */
    int command;            /* Command type (if command frame) */
    int length;             /* Data length */
    unsigned char *data;    /* Frame data */
} BINKP_FRAME;

/* ******************************************************************************************************************************************************** */
/* Function Prototypes - Frame I/O                                                                                                                          */
/* ******************************************************************************************************************************************************** */

/* Build frames for transmission */
int binkp_build_command(unsigned char *buffer, BINKP_COMMAND cmd, const char *arg);
int binkp_build_data(unsigned char *buffer, const unsigned char *data, int length);

/* Parse received frames */
int binkp_parse_frame(const unsigned char *buffer, int length, BINKP_FRAME *frame);
int binkp_frame_complete(const unsigned char *buffer, int length);
int binkp_get_frame_length(const unsigned char *buffer);

/* ******************************************************************************************************************************************************** */
/* Function Prototypes - Protocol Handling                                                                                                                  */
/* ******************************************************************************************************************************************************** */

/* Session initiation */
void binkp_send_handshake(MAILER_SESSION *session);
void binkp_send_password(MAILER_SESSION *session);

/* Command handlers */
void binkp_handle_frame(MAILER_SESSION *session, BINKP_FRAME *frame);
void binkp_handle_nul(MAILER_SESSION *session, const char *data);
void binkp_handle_adr(MAILER_SESSION *session, const char *data);
void binkp_handle_pwd(MAILER_SESSION *session, const char *data);
void binkp_handle_ok(MAILER_SESSION *session, const char *data);
void binkp_handle_err(MAILER_SESSION *session, const char *data);
void binkp_handle_bsy(MAILER_SESSION *session, const char *data);
void binkp_handle_eob(MAILER_SESSION *session);

/* File transfer commands */
void binkp_handle_file(MAILER_SESSION *session, const char *data);
void binkp_handle_got(MAILER_SESSION *session, const char *data);
void binkp_handle_skip(MAILER_SESSION *session, const char *data);
void binkp_handle_get(MAILER_SESSION *session, const char *data);
void binkp_handle_data(MAILER_SESSION *session, const unsigned char *data, int length);

/* Sending commands */
void binkp_send_nul(MAILER_SESSION *session, const char *key, const char *value);
void binkp_send_adr(MAILER_SESSION *session);
void binkp_send_pwd(MAILER_SESSION *session);
void binkp_send_ok(MAILER_SESSION *session, int secure);
void binkp_send_err(MAILER_SESSION *session, const char *message);
void binkp_send_bsy(MAILER_SESSION *session, const char *message);
void binkp_send_eob(MAILER_SESSION *session);
void binkp_send_file(MAILER_SESSION *session, const char *filename, long size, time_t mtime, long offset);
void binkp_send_got(MAILER_SESSION *session, const char *filename, long size, time_t mtime);
void binkp_send_skip(MAILER_SESSION *session, const char *filename, long size, time_t mtime);
void binkp_send_get(MAILER_SESSION *session, const char *filename, long size, long mtime, long offset);
void binkp_send_get_freq(MAILER_SESSION *session, const char *filename, const char *password);

/* File transfer */
void binkp_start_send_file(MAILER_SESSION *session, const char *path);
void binkp_send_file_data(MAILER_SESSION *session);
void binkp_finish_send_file(MAILER_SESSION *session);
void binkp_start_receive_file(MAILER_SESSION *session, const char *filename, long size, time_t mtime, long offset);
void binkp_receive_file_data(MAILER_SESSION *session, const unsigned char *data, int length);
void binkp_finish_receive_file(MAILER_SESSION *session);

/* File requests */
void binkp_process_req_file(MAILER_SESSION *session, const char *path);

/* Session flow */
void binkp_process_session(MAILER_SESSION *session);
void binkp_check_for_files(MAILER_SESSION *session);
void binkp_try_session_restart(MAILER_SESSION *session);
int binkp_is_file_received(MAILER_SESSION *session, const char *filename, long size, time_t mtime);

/* Compression */
void binkp_compress_init(MAILER_SESSION *session, int type);
void binkp_compress_deinit(MAILER_SESSION *session);
int binkp_compress_data(MAILER_SESSION *session, unsigned char *dst, int *dst_len,
                        const unsigned char *src, int src_len, int finish);
void binkp_decompress_init(MAILER_SESSION *session, int type);
void binkp_decompress_deinit(MAILER_SESSION *session);
int binkp_decompress_data(MAILER_SESSION *session, unsigned char *dst, int *dst_len,
                          const unsigned char *src, int src_len);

/* Encryption */
void binkp_init_session_encryption(MAILER_SESSION *session);
void binkp_crypt_init(MAILER_SESSION *session, const char *password);
void binkp_encrypt_buf(unsigned char *buf, int len, unsigned long keys[3]);
void binkp_decrypt_buf(unsigned char *buf, int len, unsigned long keys[3]);

/* TRF info */
void binkp_send_trf(MAILER_SESSION *session);
void binkp_calculate_pending(MAILER_SESSION *session);

/* M_SKIP during receive */
void binkp_skip_current_file(MAILER_SESSION *session);

/* ******************************************************************************************************************************************************** */
/* Function Prototypes - Authentication                                                                                                                     */
/* ******************************************************************************************************************************************************** */

/* CRAM-MD5 authentication */
void binkp_generate_challenge(char *buffer, size_t size);
int binkp_verify_cram_response(const char *challenge, const char *password, const char *response);
void binkp_compute_cram_response(const char *challenge, const char *password, char *response, size_t size);

/* Password lookup */
const char *binkp_get_password_for_node(const FTN_ADDR *addr);

#endif
