/* ******************************************************************************************************************************************************** */
/* Support Module - Line Configuration                                                                                                                      */
/* ******************************************************************************************************************************************************** */

#include <stdio.h>
#include <string.h>
#include <stdlib.h>

#include "kernel.h"
#include "swis.h"

#include "lineconfig.h"
#include "debug.h"

/* Static storage for line configuration */
static LINE_CONFIG line_configs[LINECONFIG_MAX_LINES];

/* ================================================================================================================== */
/* INITIALISATION AND FINALISATION                                                                                    */
/* ================================================================================================================== */

void lineconfig_initialise(void)
{
    int i;

    debug_printf("lineconfig_initialise: Clearing %d line configs", LINECONFIG_MAX_LINES);

    for (i = 0; i < LINECONFIG_MAX_LINES; i++)
    {
        line_configs[i].line_number = i;
        line_configs[i].enabled = 0;
        line_configs[i].botstopper[0] = '\0';
        line_configs[i].hello[0] = '\0';
    }
}

void lineconfig_finalise(void)
{
    debug_printf("lineconfig_finalise: Cleanup complete");
}

/* ================================================================================================================== */
/* SWI HANDLER                                                                                                        */
/* ================================================================================================================== */

void lineconfig_swi_handler(_kernel_swi_regs *r)
{
    int reason = r->r[0];
    int line = r->r[1];
    int field = r->r[2];
    const char *str_value;

    /* Validate line number */
    if (line < 0 || line >= LINECONFIG_MAX_LINES)
    {
        debug_printf("lineconfig_swi_handler: Invalid line %d", line);
        r->r[0] = -1;
        return;
    }

    switch (reason)
    {
        case LINECONFIG_REASON_SET:
            switch (field)
            {
                case LINECONFIG_FIELD_ENABLED:
                    line_configs[line].enabled = r->r[3];
                    debug_printf("lineconfig: Line %d enabled=%d", line, r->r[3]);
                    break;

                case LINECONFIG_FIELD_BOTSTOPPER:
                    str_value = (const char *)r->r[3];
                    if (str_value)
                    {
                        strncpy(line_configs[line].botstopper, str_value, LINECONFIG_BOTSTOPPER_LEN - 1);
                        line_configs[line].botstopper[LINECONFIG_BOTSTOPPER_LEN - 1] = '\0';
                    }
                    else
                    {
                        line_configs[line].botstopper[0] = '\0';
                    }
                    debug_printf("lineconfig: Line %d botstopper='%s'", line, line_configs[line].botstopper);
                    break;

                case LINECONFIG_FIELD_HELLO:
                    str_value = (const char *)r->r[3];
                    if (str_value)
                    {
                        strncpy(line_configs[line].hello, str_value, LINECONFIG_HELLO_LEN - 1);
                        line_configs[line].hello[LINECONFIG_HELLO_LEN - 1] = '\0';
                    }
                    else
                    {
                        line_configs[line].hello[0] = '\0';
                    }
                    debug_printf("lineconfig: Line %d hello='%s'", line, line_configs[line].hello);
                    break;

                default:
                    debug_printf("lineconfig_swi_handler: Unknown SET field %d", field);
                    r->r[0] = -1;
                    return;
            }
            r->r[0] = 0;
            break;

        case LINECONFIG_REASON_GET:
            switch (field)
            {
                case LINECONFIG_FIELD_ENABLED:
                    r->r[0] = line_configs[line].enabled;
                    break;

                case LINECONFIG_FIELD_BOTSTOPPER:
                    r->r[0] = (int)line_configs[line].botstopper;
                    break;

                case LINECONFIG_FIELD_HELLO:
                    r->r[0] = (int)line_configs[line].hello;
                    break;

                default:
                    debug_printf("lineconfig_swi_handler: Unknown GET field %d", field);
                    r->r[0] = -1;
                    return;
            }
            break;

        default:
            debug_printf("lineconfig_swi_handler: Unknown reason %d", reason);
            r->r[0] = -1;
            break;
    }
}

/* ================================================================================================================== */
/* DIRECT ACCESS FOR CLI                                                                                              */
/* ================================================================================================================== */

const LINE_CONFIG *lineconfig_get(int line)
{
    if (line < 0 || line >= LINECONFIG_MAX_LINES)
    {
        return NULL;
    }
    return &line_configs[line];
}

int lineconfig_count_enabled(void)
{
    int i, count = 0;

    for (i = 0; i < LINECONFIG_MAX_LINES; i++)
    {
        if (line_configs[i].enabled)
        {
            count++;
        }
    }
    return count;
}
