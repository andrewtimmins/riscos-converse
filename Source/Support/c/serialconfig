/* ******************************************************************************************************************************************************** */
/* Support Module - Serial Configuration                                                                                                                    */
/* ******************************************************************************************************************************************************** */

#include <stdio.h>
#include <string.h>

#include "serialconfig.h"

static SERIAL_CONFIG serial_configs[SERIALCONFIG_MAX_LINES];

/* ******************************************************************************************************************************************************** */
/* Initialisation and Finalisation                                                                                                                          */
/* ******************************************************************************************************************************************************** */

void serialconfig_initialise(void)
{
    int i;

    for (i = 0; i < SERIALCONFIG_MAX_LINES; i++)
    {
        memset(&serial_configs[i], 0, sizeof(SERIAL_CONFIG));
    }
}

void serialconfig_finalise(void)
{
    /* Nothing to clean up */
}

/* ******************************************************************************************************************************************************** */
/* SWI Handler                                                                                                                                              */
/* ******************************************************************************************************************************************************** */

void serialconfig_swi_handler(_kernel_swi_regs *r)
{
    SERIAL_CONFIG_REASON reason;
    int line;

    if (r == NULL)
    {
        return;
    }

    reason = (SERIAL_CONFIG_REASON)r->r[0];
    line = r->r[1];

    if (line < 0 || line >= SERIALCONFIG_MAX_LINES)
    {
        r->r[0] = -1;
        return;
    }

    switch (reason)
    {
        case SERIAL_CONFIG_REASON_GET:
        {
            /* Return pointer to config */
            r->r[0] = (int)&serial_configs[line];
            break;
        }

        case SERIAL_CONFIG_REASON_SET:
        {
            const SERIAL_CONFIG *src = (const SERIAL_CONFIG *)r->r[2];
            if (src != NULL)
            {
                memcpy(&serial_configs[line], src, sizeof(SERIAL_CONFIG));
                r->r[0] = 0;
            }
            else
            {
                r->r[0] = -1;
            }
            break;
        }

        default:
            r->r[0] = -1;
            break;
    }
}

/* ******************************************************************************************************************************************************** */
/* Direct Access Functions                                                                                                                                  */
/* ******************************************************************************************************************************************************** */

const SERIAL_CONFIG *serialconfig_get(int line)
{
    if (line < 0 || line >= SERIALCONFIG_MAX_LINES)
    {
        return NULL;
    }

    return &serial_configs[line];
}

int serialconfig_set(int line, const SERIAL_CONFIG *config)
{
    if (line < 0 || line >= SERIALCONFIG_MAX_LINES || config == NULL)
    {
        return -1;
    }

    memcpy(&serial_configs[line], config, sizeof(SERIAL_CONFIG));
    return 0;
}
