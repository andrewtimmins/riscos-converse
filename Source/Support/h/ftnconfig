/* ******************************************************************************************************************************************************** */
/* Support Module - FTN Configuration                                                                                                                       */
/* ******************************************************************************************************************************************************** */

#ifndef FTNCONFIG_H
#define FTNCONFIG_H

#include "kernel.h"

/* Maximum limits */
#define FTN_CONFIG_MAX_ADDRESSES        8
#define FTN_CONFIG_MAX_UPLINKS          16
#define FTN_CONFIG_MAX_DOWNLINKS        32
#define FTN_CONFIG_MAX_ALIASES          8
#define FTN_CONFIG_NAME_LEN             64
#define FTN_CONFIG_PATH_LEN             256
#define FTN_CONFIG_PASSWORD_LEN         32
#define FTN_CONFIG_GROUPS_LEN           64
#define FTN_CONFIG_AREAS_LEN            256
#define FTN_CONFIG_FLAGS_LEN            64

/* FTN address configuration */
typedef struct
{
    int id;                                     /* address ID (1-based) */
    char network[FTN_CONFIG_NAME_LEN];          /* network name (Fidonet, etc.) */
    int zone;                                   /* zone number */
    int net;                                    /* net number */
    int node;                                   /* node number */
    int point;                                  /* point number */
    char type[8];                               /* address type (4d, 5d) */
} FTN_ADDRESS_CONFIG;

/* FTN uplink configuration */
typedef struct
{
    int id;                                     /* uplink ID (1-based) */
    char address[FTN_CONFIG_NAME_LEN];          /* uplink address string */
    char network[FTN_CONFIG_NAME_LEN];          /* network this uplink belongs to */
    char host[FTN_CONFIG_NAME_LEN];             /* hostname or IP address */
    int port;                                   /* port number (default 24554) */
    char password[FTN_CONFIG_PASSWORD_LEN];     /* session password */
    char areafix_password[FTN_CONFIG_PASSWORD_LEN];   /* password for AreaFix requests */
    char filefix_password[FTN_CONFIG_PASSWORD_LEN];   /* password for FileFix requests */
    char groups[FTN_CONFIG_GROUPS_LEN];         /* groups we receive from this uplink */
    int alias_count;                            /* number of aliases */
    char aliases[FTN_CONFIG_MAX_ALIASES][FTN_CONFIG_NAME_LEN];  /* AKA addresses */
} FTN_UPLINK_CONFIG;

/* FTN downlink configuration - points/nodes we feed */
typedef struct
{
    int id;                                     /* downlink ID (1-based) */
    char address[FTN_CONFIG_NAME_LEN];          /* downlink address string */
    char name[FTN_CONFIG_NAME_LEN];             /* descriptive name */
    char password[FTN_CONFIG_PASSWORD_LEN];           /* BinkP session password */
    char areafix_password[FTN_CONFIG_PASSWORD_LEN];   /* password for AreaFix requests */
    char filefix_password[FTN_CONFIG_PASSWORD_LEN];   /* password for FileFix requests */
    char allowed_groups[FTN_CONFIG_GROUPS_LEN];       /* groups they can subscribe to */
    char allowed_echoes[FTN_CONFIG_AREAS_LEN];        /* specific areas they can access */
    char allowed_files[FTN_CONFIG_AREAS_LEN];         /* specific file areas they can access */
    int max_echoes;                             /* max echomail areas allowed (0=unlimited) */
    int max_files;                              /* max file areas allowed (0=unlimited) */
} FTN_DOWNLINK_CONFIG;

/* Global FTN settings */
typedef struct
{
    /* System information */
    char sysop[FTN_CONFIG_NAME_LEN];            /* sysop name */
    char system[FTN_CONFIG_NAME_LEN];           /* system name */
    char location[FTN_CONFIG_NAME_LEN];         /* location */
    char phone[FTN_CONFIG_NAME_LEN];            /* phone number */
    int speed;                                  /* connection speed */
    char flags[FTN_CONFIG_FLAGS_LEN];           /* mailer flags */

    /* Paths */
    char inbound[FTN_CONFIG_PATH_LEN];          /* inbound directory */
    char outbound[FTN_CONFIG_PATH_LEN];         /* outbound directory */
    char netmail[FTN_CONFIG_PATH_LEN];          /* netmail directory */
    char nodelists[FTN_CONFIG_PATH_LEN];        /* nodelists directory */
    char freqpath[FTN_CONFIG_PATH_LEN];         /* FREQ files directory */
    char freqexec[FTN_CONFIG_PATH_LEN];         /* External FREQ processor command */

    /* Packet settings */
    long max_packet_size;                       /* maximum packet size */

    /* Mailer runtime settings */
    int listen_port;                            /* inbound BinkP port */
    int max_sessions;                           /* concurrent sessions */
    int connect_timeout;                        /* connect timeout (seconds) */
    int session_timeout;                        /* idle session timeout (seconds) */
    int scan_interval;                          /* outbound rescan interval (seconds) */
    int toss_interval;                          /* auto-toss interval (seconds, 0=disabled) */
    int poll_interval;                          /* auto-poll interval (seconds, 0=disabled) */
    int retry_delay;                            /* retry delay after session (seconds) */

    /* Addresses */
    int address_count;                          /* number of addresses */
    FTN_ADDRESS_CONFIG addresses[FTN_CONFIG_MAX_ADDRESSES];

    /* Uplinks */
    int uplink_count;                           /* number of uplinks */
    FTN_UPLINK_CONFIG uplinks[FTN_CONFIG_MAX_UPLINKS];

    /* Downlinks */
    int downlink_count;                         /* number of downlinks */
    FTN_DOWNLINK_CONFIG downlinks[FTN_CONFIG_MAX_DOWNLINKS];
} FTN_GLOBAL_CONFIG;

/* SWI reason codes for ConverseBBS_FTNConfig (0x5AA86) */
typedef enum
{
    FTN_CONFIG_REASON_GET_GLOBAL = 0,           /* -> R0=FTN_GLOBAL_CONFIG ptr */
    FTN_CONFIG_REASON_SET_GLOBAL = 1,           /* R1=field, R2=value */
    FTN_CONFIG_REASON_GET_ADDRESS = 2,          /* R1=addr_id -> R0=FTN_ADDRESS_CONFIG ptr */
    FTN_CONFIG_REASON_SET_ADDRESS = 3,          /* R1=addr_id, R2=FTN_ADDRESS_CONFIG ptr */
    FTN_CONFIG_REASON_GET_UPLINK = 4,           /* R1=uplink_id -> R0=FTN_UPLINK_CONFIG ptr */
    FTN_CONFIG_REASON_SET_UPLINK = 5,           /* R1=uplink_id, R2=FTN_UPLINK_CONFIG ptr */
    FTN_CONFIG_REASON_COUNT_ADDRESSES = 6,      /* -> R0=count */
    FTN_CONFIG_REASON_COUNT_UPLINKS = 7,        /* -> R0=count */
    FTN_CONFIG_REASON_GET_DOWNLINK = 8,         /* R1=downlink_id -> R0=FTN_DOWNLINK_CONFIG ptr */
    FTN_CONFIG_REASON_SET_DOWNLINK = 9,         /* R1=downlink_id, R2=FTN_DOWNLINK_CONFIG ptr */
    FTN_CONFIG_REASON_COUNT_DOWNLINKS = 10      /* -> R0=count */
} FTN_CONFIG_REASON;

/* Global config fields for SET_GLOBAL */
typedef enum
{
    FTN_GLOBAL_FIELD_SYSOP = 0,
    FTN_GLOBAL_FIELD_SYSTEM = 1,
    FTN_GLOBAL_FIELD_LOCATION = 2,
    FTN_GLOBAL_FIELD_PHONE = 3,
    FTN_GLOBAL_FIELD_SPEED = 4,
    FTN_GLOBAL_FIELD_FLAGS = 5,
    FTN_GLOBAL_FIELD_INBOUND = 6,
    FTN_GLOBAL_FIELD_OUTBOUND = 7,
    FTN_GLOBAL_FIELD_NETMAIL = 8,
    FTN_GLOBAL_FIELD_MAX_PACKET = 9,
    FTN_GLOBAL_FIELD_LISTENPORT = 10,
    FTN_GLOBAL_FIELD_MAXSESSIONS = 11,
    FTN_GLOBAL_FIELD_CONNECTTIMEOUT = 12,
    FTN_GLOBAL_FIELD_SESSIONTIMEOUT = 13,
    FTN_GLOBAL_FIELD_SCANINTERVAL = 14,
    FTN_GLOBAL_FIELD_TOSSINTERVAL = 15,
    FTN_GLOBAL_FIELD_POLLINTERVAL = 16,
    FTN_GLOBAL_FIELD_RETRYDELAY = 17,
    FTN_GLOBAL_FIELD_FREQPATH = 18,
    FTN_GLOBAL_FIELD_FREQEXEC = 19,
    FTN_GLOBAL_FIELD_NODELISTS = 20
} FTN_GLOBAL_FIELD;

/* Initialisation and finalisation */
void ftnconfig_initialise(void);
void ftnconfig_finalise(void);

/* SWI handler */
void ftnconfig_swi_handler(_kernel_swi_regs *r);

/* Direct access for CLI commands */
const FTN_GLOBAL_CONFIG *ftnconfig_get(void);
const FTN_ADDRESS_CONFIG *ftnconfig_get_address(int addr_id);
const FTN_UPLINK_CONFIG *ftnconfig_get_uplink(int uplink_id);
const FTN_DOWNLINK_CONFIG *ftnconfig_get_downlink(int downlink_id);

#endif
