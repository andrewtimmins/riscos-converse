/* ******************************************************************************************************************************************************** */
/* Serial Handler - Debug Module                                                                                                                            */
/* ******************************************************************************************************************************************************** */

#include <stdio.h>
#include <stdarg.h>
#include <string.h>

#include "kernel.h"
#include "swis.h"

#include "debug.h"

/* ******************************************************************************************************************************************************** */
/* Reporter SWI                                                                                                                                             */
/* ******************************************************************************************************************************************************** */

#define Report_Text0    0x54C80

static int debug_enabled = 0;

/* ******************************************************************************************************************************************************** */
/* Debug Initialisation                                                                                                                                     */
/* ******************************************************************************************************************************************************** */

void debug_initialise(void)
{
    _kernel_swi_regs regs;

    /* Check if Reporter module is loaded by trying to call it */
    regs.r[0] = (int)"Serial: Debug initialised";
    if (_kernel_swi(Report_Text0, &regs, &regs) == NULL)
    {
        debug_enabled = 1;
    }
}

void debug_finalise(void)
{
    debug_enabled = 0;
}

/* ******************************************************************************************************************************************************** */
/* Debug Output                                                                                                                                             */
/* ******************************************************************************************************************************************************** */

void debug_printf(const char *format, ...)
{
    char buffer[512];
    va_list args;
    _kernel_swi_regs regs;

    if (!debug_enabled)
    {
        return;
    }

    va_start(args, format);
    vsnprintf(buffer, sizeof(buffer), format, args);
    va_end(args);

    /* Remove any trailing newline for Reporter */
    if (buffer[0] != '\0' && buffer[strlen(buffer) - 1] == '\n')
    {
        buffer[strlen(buffer) - 1] = '\0';
    }

    regs.r[0] = (int)buffer;
    _kernel_swi(Report_Text0, &regs, &regs);
}
