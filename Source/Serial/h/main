/* ******************************************************************************************************************************************************** */
/* Serial Handler - Main Header                                                                                                                             */
/* ******************************************************************************************************************************************************** */

#ifndef MAIN_H
#define MAIN_H

#include <time.h>
#include "C:Desk.Wimp.h"

/* ============================================================================
 * Configuration
 * ============================================================================ */

#define SERIAL_MAX_LINES        32
#define SERIAL_POLL_DELAY       1       /* centiseconds between null polls (10ms) */
#define PIPE_TRANSFER_CHUNK     1536    /* Transfer buffer size */
#define RING_TIMEOUT_CS         500     /* Ring count reset timeout (5 seconds in centiseconds) */
#define ESCAPE_GUARD_TIME_CS    100     /* +++ escape guard time (1 second in centiseconds) */

/* ============================================================================
 * Status Window Configuration
 * ============================================================================ */

#define SERIALSTATUS_ICON_HEIGHT        64
#define SERIALSTATUS_PADDING            10
#define SERIALSTATUS_BOTTOM_PADDING     0
#define SERIALSTATUS_TOP_STATIC_ROWS    1
#define SERIALSTATUS_COLUMN_START       8
#define SERIALSTATUS_COLUMN_GAP         8
#define SERIALSTATUS_LINE_WIDTH         88
#define SERIALSTATUS_STATUS_WIDTH       600     /* Activity/status text column */
#define SERIALSTATUS_BUTTON_WIDTH       64      /* Sprite button with border */

/* Dynamic icon layout - icons created after template static icons */
#define SERIALSTATUS_ICON_BASE          3       /* First dynamic icon number (template modified) */
#define SERIALSTATUS_ICONS_PER_LINE     4       /* Icons per serial line row */
#define SERIALSTATUS_COLUMN_LINE        0       /* Line number column */
#define SERIALSTATUS_COLUMN_STATUS      1       /* Status column */
#define SERIALSTATUS_COLUMN_TERMINAL    2       /* Terminal button column */
#define SERIALSTATUS_COLUMN_INIT        3       /* Init button column */

/* ============================================================================
 * Wimp Messages
 * ============================================================================ */

/* Wimp message from Converse Server */
#define MESSAGE_LINE_BROADCAST      0x5AA00

/* Messages from Serial to Server */
#define MESSAGE_SERIAL_CONNECT      0x5AA06
#define MESSAGE_SERIAL_DISCONNECT   0x5AA07

/* ============================================================================
 * SWI Numbers
 * ============================================================================ */

#define SWI_OS_READMONOTONICTIME    0x00000042

/* Pipes module SWIs */
#define PIPES_SWI_BASE                      0x5AA00
#define SWI_CONVERSE_PIPES_INPUT_STATUS     (PIPES_SWI_BASE + 2)
#define SWI_CONVERSE_PIPES_CLEAR_INPUT      (PIPES_SWI_BASE + 6)
#define SWI_CONVERSE_PIPES_CLEAR_OUTPUT     (PIPES_SWI_BASE + 7)
#define SWI_CONVERSE_PIPES_INPUT_WRITE_BLOCK (PIPES_SWI_BASE + 13)
#define SWI_CONVERSE_PIPES_OUTPUT_READ_BLOCK (PIPES_SWI_BASE + 14)
#define SWI_CONVERSE_PIPES_RESET_STATE      (PIPES_SWI_BASE + 10)

/* Support module SWIs */
#define SWI_CONVERSEBBS_LINE            0x5AA81
#define SWI_CONVERSEBBS_SERIAL_CONFIG   0x5AA88

/* Filer logging SWI */
#define SWI_FILER_LOGGING               0x5AA40
#define FILER_LOG_CMD_SERIAL            5

/* ============================================================================
 * Support Module Constants
 * ============================================================================ */

#define LINE_REASON_SET             0
#define LINE_REASON_GET             1

#define LINE_FIELD_CONFIGURED       0
#define LINE_FIELD_CONNECTED        1
#define LINE_FIELD_USER_ID          2
#define LINE_FIELD_CONNECT_TIME     3
#define LINE_FIELD_HOSTNAME         4
#define LINE_FIELD_TRANSFER         5
#define LINE_FIELD_TYPE             6

/* Line types */
#define LINE_TYPE_TELNET            0
#define LINE_TYPE_SERIAL            1
#define LINE_TYPE_LOCAL             2

/* ============================================================================
 * Pipe Control Frames
 * ============================================================================ */

#define PIPE_CONTROL_TOKEN          ((unsigned char)0x00)
#define PIPE_CONTROL_CONNECT        'C'
#define PIPE_CONTROL_DISCONNECT     'D'

/* Forward declaration for terminal state */
struct ansiterm_state_tag;

/* ============================================================================
 * Serial Line Configuration (from Support module)
 * ============================================================================ */

typedef struct
{
    int enabled;                    /* Is this a serial line? */
    char driver_name[32];           /* BlockDriver name */
    int port_number;                /* Port (0-based) */
    int baud_rate;                  /* Speed */
    int word_format;                /* 8N1 etc encoded */
    int flow_control;               /* Flow control mode */
    int rings;                      /* Rings to wait before answering */
    char init[64];                  /* Modem init string */
    char ring[32];                  /* Ring indicator string */
    char answer[32];                /* Answer command */
} SERIAL_LINE_CONFIG;

/* ============================================================================
 * Serial Line State (runtime)
 * ============================================================================ */

typedef struct
{
    int line_id;                    /* Line number */
    int enabled;                    /* Is this line active? */
    int (*driver)(int, ...);        /* BlockDriver function pointer */
    int port_number;                /* Port number */
    int baud_rate;                  /* Baud rate */
    int word_format;                /* Word format */
    int flow_control;               /* Flow control */
    int rings;                      /* Rings to wait before answer */
    int carrier_detect;             /* Current DCD state */
    char init[64];                  /* Modem init string */
    char ring[32];                  /* Ring indicator string */
    char answer[32];                /* Answer command */
    int ring_count;                 /* Rings observed so far */
    int ring_match_index;           /* Current match position within ring string */
    clock_t last_activity;          /* Last activity time */
    clock_t last_ring_time;         /* Time of last ring detection (for timeout) */
    char driver_name[32];           /* Driver name for debug */

    /* Pending write buffer for partial serial/pipe writes */
    char pending_serial[PIPE_TRANSFER_CHUNK];
    int pending_serial_offset;
    int pending_serial_length;

    /* +++ escape sequence guard */
    int escape_plus_count;          /* Consecutive '+' characters seen */
    clock_t escape_silence_start;   /* Start of silence period before +++ */
    int escape_guard_active;        /* Currently in escape guard state */

    /* Terminal mode (exclusive serial access) */
    int terminal_active;            /* Terminal window is open */
    struct ansiterm_state_tag *terminal;  /* Terminal state (if active) */
} SERIAL_LINE_STATE;

/* ============================================================================
 * Status Row Structure (for dynamic icon text buffers)
 * ============================================================================ */

typedef struct
{
    char *line_text;                /* Line number display buffer */
    char *status_text;              /* Status text display buffer */
    char *terminal_text;            /* Terminal button text buffer (empty) */
    char *init_text;                /* Init button text buffer (empty) */
} SERIAL_STATUS_ROW;

/* ============================================================================
 * Wimp State
 * ============================================================================ */

typedef struct
{
    Desk_bool quit;
    Desk_icon_handle iconbar_icon;
    Desk_menu_ptr iconbar_menu;
    Desk_window_handle status_window;
} WIMP_STATE;

/* =================== =========================================================
 * Global State
 * ============================================================================ */

extern WIMP_STATE wimp;
extern SERIAL_LINE_STATE serial_lines[SERIAL_MAX_LINES];
extern int serial_line_count;
extern SERIAL_STATUS_ROW *serial_status_rows;
extern int serial_status_row_count;

/* ============================================================================
 * Function Prototypes
 * ============================================================================ */

/* Pipe helpers */
int pipes_input_status(int line_id);
int pipes_input_write_block(int line_id, const char *buffer, int length);
int pipes_output_read_block(int line_id, char *buffer, int length);
void pipes_reset_line(int line_id);
void pipes_send_control_command(int line_id, char command);

/* Support module helpers */
void support_set_line_connected(int line_id, int connected);
void support_set_line_hostname(int line_id, const char *hostname);
void support_set_line_connect_time(int line_id, time_t connect_time);
int support_get_line_type(int line_id);
int support_get_serial_config(int line_id, SERIAL_LINE_CONFIG *config);

/* Wimp message sending */
void send_serial_connect_message(int line_id);
void send_serial_disconnect_message(int line_id);

/* Logging */
void serial_log(const char *format, ...);

/* Status window functions */
int serialstatus_create_icons(void);
void serialstatus_free_icons(void);
void serialstatus_set_extent(void);
void serialstatus_update_line(int line_index, const char *status);
int serialstatus_icon_index(int line_index, int column);

/* Terminal functions */
void serial_open_terminal(int line_index);
void serial_close_terminal(int line_index);
int serial_terminal_active(int line_index);

/* Init functions */
void serial_reinit_line(int line_index);

#endif /* MAIN_H */
